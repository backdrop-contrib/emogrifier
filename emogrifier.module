<?php

/**
 * @file
 * This module uses the emogrifier class library as an input filter to convert
 * stylesheet rules to inline style attributes.  This ensures proper display
 * on email and mobile device readers that lack stylesheet support.
 *
 * @see http://www.pelagodesign.com/sidecar/emogrifier/
 */

/**
 * Implements hook_help().
 */
function emogrifier_help($path = 'admin/help#emogrifier', $arg) {
  switch ($path) {
    case 'admin/help#emogrifier':
      return '<p>'. t(
        'The <a href="@module">%emogrifier</a> module uses the'
        . ' <a href="@class">%emogrifier</a> class library to convert stylesheet'
        . ' rules to inline style attributes. This ensures proper display on email'
        . ' and mobile device readers that lack stylesheet support.',
        array(
          '@module' => url('http://drupal.org/project/emogrifier'),
          '%emogrifier' => 'emogrifier',
          '@class' => url('http://www.pelagodesign.com/sidecar/emogrifier/'),
        )
      ) . '</p>';
      break;
  }
}

/**
 * Implements hook_filter_info().
 */
function emogrifier_filter_info() {
  return array(
    'filter_emogrifier' => array(
      'title' => t('Emogrifier'),
      'description' => t('Converts stylesheet rules to inline style attributes.'),
      'process callback' => '_filter_emogrifier_process',
      'tips callback' => '_filter_emogrifier_tips',
    ),
  );
}

/**
 * Implements hook_filter_FILTER_process().
 @see emogrifier_filter_info()
 */
function _filter_emogrifier_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  if (empty($text)) {
    return '';
  }
  // Avoid PHP fatal errors when the 'dom' extension is not loaded.
  if (!extension_loaded('dom')) {
    watchdog(
      'emogrifier',
      'The PHP <a href="@dom">%dom</a> extension required by '
      . '<a href="@emogrifier">%emogrifier</a> is not loaded.',
      array(
        '@dom' => url('http://php.net/dom'),
        '%dom' => 'dom',
        '@emogrifier' => url('http://drupal.org/project/emogrifier'),
        '%emogrifier' => 'emogrifier',
      ),
      WATCHDOG_WARNING
    );
    return $text;
  }
  if (!_emogrifier_available()) {
    watchdog(
      'emogrifier',
      'The <a href="@library">%emogrifier</a> class library required by the'
      . ' <a href="@module">%emogrifier</a> module could not be loaded.',
      array(
        '@library' => url('http://www.pelagodesign.com/sidecar/emogrifier/'),
        '%emogrifier' => 'emogrifier',
        '@module' => url('http://drupal.org/project/emogrifier'),
      ),
      WATCHDOG_WARNING
    );
    return $text;
  }
  $style = array();
  $urls = array();
  // Fetch the contents of Drupal-generated linked stylesheets with media="all".
  if (preg_match_all(
      '#<link\s*type\s*=\s*(["\'])text/css\1\s+rel\s*=\s*(["\'])stylesheet\2\s+href\s*=\s*(["\'])(.*)\3\s+media\s*=\s*(["\']?)all\5\s*/>#Usi',
      $text, $match)) {
    $urls = array_merge($urls, $match[4]);
    $text = str_replace($match[0], '', $text);
  }
  if (preg_match_all(
      '#<style\s+type\s*=\s*(["\'])text/css\1\s+media\s*=\s*(["\'])all\2\s*>(.*)</style>#Usi',
      $text, $match)) {
    foreach ($match[3] as $imports) {
      if (preg_match_all(
          '#@import\s+url\s*\(\s*(["\'])(.*)\1\s*\)\s*;#',
          $imports, $import)) {
        $urls = array_merge($urls, $import[2]);
      }
    }
    $text = str_replace($match[0], '', $text);
  }
  foreach ($urls as $url) {
    if ( ($path = drupal_realpath(DRUPAL_ROOT . parse_url($url, PHP_URL_PATH)))
      && (is_readable($path) && !is_dir($path)) ) {
      $style[] = file_get_contents($path);
    }
  }
  // Extract the contents of any remaining inline stylesheet rules.
  if (preg_match_all(
      '#<style[^>]*>\s*(<!--)?\s*?(.*?)\s*(-->)?\s*</style>#si',
      $text, $matches)) {
    $style = array_merge($style, $matches[2]);
    $text = str_replace($matches[0], '', $text);
  }
  // Strip comments and unecessary whitespace from the collected style rules.
  $style = preg_replace(array("/[[:space:]]+/", '#/\*.*?\*/#', '/ +/'), ' ', $style);
  // Emogrify can't handle several CSS rules on one line, so insert a newline
  // character after each closing bracket.
  $style = preg_replace('/}\s*/', "}\n", implode("\n", $style));
  // Get and reset error levels to avoid DOMDocument::loadHTML() errors.
  $errorlevel = error_reporting(0);
  // Load the html text and style rules.
  $emogrifier = new Emogrifier($text, $style);
  // Apply the rules to create inline style attributes.
  $text = $emogrifier->emogrify();
  error_reporting($errorlevel);
  // Strip class and role attributes, strip html comments,
  // and replace <header> with <div>.
  $text = preg_replace(
    array(
      '#(<[^>]*?)\s*class\s*=\s*(["\']).*?\2(\s*[^>])?#si',
      '#(<[^>]*?)\s*role\s*=\s*(["\']).*?\2(\s*[^>])?#si',
      '#\s*<!--.*?-->\s*#si',
      '#(<(/?))header#si',
    ),
    array(
      '\1\4',
      '\1\4',
      '',
      '\1div'
    ),
    $text
  );
  // @todo Strip any whitespace outside of <pre> or <code> tags?
  return $text;
}

/**
 * Returns TRUE if the Emogrifier class is available.
 */
function _emogrifier_available() {
  if (class_exists('Emogrifier')) {
    return TRUE;
  }
  $path = libraries_get_path('emogrifier') . '/emogrifier.php';
  if (!file_exists($path)) {
    return FALSE;
  }
  include_once libraries_get_path('emogrifier') . '/emogrifier.php';
  return class_exists('Emogrifier');
}

/**
 * Implements hook_filter_FILTER_tips().
 @see emogrifier_filter_info()
 */
function _filter_emogrifier_tips($filter, $format, $long) {
  return t('Stylesheet rules will be converted to inline style attributes.');
}
